<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Authorization - Vera's Travel Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .code-display {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 20px 0;
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #E4405F, #F77737);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .error {
            background: rgba(220, 53, 69, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: rgba(40, 167, 69, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .step {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #E4405F;
            text-align: left;
        }

        .countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <h1 id="pageTitle">ğŸ” è™•ç† Instagram æˆæ¬Š</h1>
        <div class="status-message" id="statusMessage">æ­£åœ¨è™•ç†æ‚¨çš„ Instagram æˆæ¬Š...</div>
        
        <div id="contentArea">
            <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>

        <div class="code-display" id="codeDisplay"></div>

        <div id="actionButtons" style="display: none;">
            <a href="index.html" class="btn">ğŸ—ºï¸ å‰å¾€åœ°åœ–</a>
            <button onclick="location.reload()" class="btn btn-secondary">ğŸ”„ é‡è©¦</button>
        </div>
    </div>

    <script>
        // Instagram API é…ç½®ï¼ˆèˆ‡ä¸»é é¢ä¿æŒä¸€è‡´ï¼‰
        const INSTAGRAM_CONFIG = {
            clientId: 'YOUR_INSTAGRAM_APP_ID', // éœ€è¦æ›¿æ›
            clientSecret: 'YOUR_INSTAGRAM_APP_SECRET', // éœ€è¦æ›¿æ›
            redirectUri: window.location.origin + window.location.pathname,
            baseURL: 'https://graph.instagram.com'
        };

        // æˆæ¬Šè™•ç†é¡
        class AuthHandler {
            constructor() {
                this.statusElement = document.getElementById('statusMessage');
                this.contentElement = document.getElementById('contentArea');
                this.codeElement = document.getElementById('codeDisplay');
                this.buttonsElement = document.getElementById('actionButtons');
                this.spinnerElement = document.getElementById('spinner');
            }

            updateStatus(message, isError = false) {
                this.statusElement.textContent = message;
                if (isError) {
                    this.statusElement.style.color = '#FFB6C1';
                } else {
                    this.statusElement.style.color = 'white';
                }
            }

            showError(message, details = '') {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'âŒ æˆæ¬Šå¤±æ•—';
                
                this.contentElement.innerHTML = `
                    <div class="error">
                        <h3>æˆæ¬Šéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤</h3>
                        <p><strong>éŒ¯èª¤ä¿¡æ¯ï¼š</strong>${message}</p>
                        ${details ? `<p><strong>è©³ç´°ä¿¡æ¯ï¼š</strong>${details}</p>` : ''}
                    </div>
                    <div class="step">
                        <h4>å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                        <ul style="text-align: left; margin-left: 20px;">
                            <li>ç¢ºèªæ‚¨çš„ Instagram æ‡‰ç”¨é…ç½®æ­£ç¢º</li>
                            <li>æª¢æŸ¥é‡å®šå‘ URI æ˜¯å¦åŒ¹é…</li>
                            <li>ç¢ºèªæ‡‰ç”¨æ¬Šé™è¨­ç½®æ­£ç¢º</li>
                            <li>å˜—è©¦é‡æ–°é–‹å§‹æˆæ¬Šæµç¨‹</li>
                        </ul>
                    </div>
                `;
                
                this.buttonsElement.style.display = 'block';
            }

            showSuccess(tokenData) {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'âœ… æˆæ¬ŠæˆåŠŸ';
                
                this.contentElement.innerHTML = `
                    <div class="success">
                        <h3>Instagram æˆæ¬Šå®Œæˆï¼</h3>
                        <p>æ‚¨çš„è¨ªå•ä»¤ç‰Œå·²å®‰å…¨ä¿å­˜ï¼Œç¾åœ¨å¯ä»¥è¨ªå•æ‚¨çš„ Instagram æ•¸æ“šã€‚</p>
                    </div>
                    <div class="step">
                        <h4>æˆæ¬Šä¿¡æ¯ï¼š</h4>
                        <p><strong>ç”¨æˆ¶ IDï¼š</strong>${tokenData.user_id || 'N/A'}</p>
                        <p><strong>ä»¤ç‰Œé¡å‹ï¼š</strong>é•·æœŸè¨ªå•ä»¤ç‰Œ</p>
                        <p><strong>æœ‰æ•ˆæœŸï¼š</strong>60 å¤©</p>
                        <p><strong>æ¬Šé™ï¼š</strong>ç”¨æˆ¶è³‡æ–™, ç”¨æˆ¶åª’é«”</p>
                    </div>
                `;

                // å€’æ•¸è¨ˆæ™‚è‡ªå‹•è·³è½‰
                this.startCountdown();
            }

            startCountdown() {
                let seconds = 5;
                const countdownElement = document.createElement('div');
                countdownElement.className = 'countdown';
                countdownElement.textContent = `${seconds} ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°åœ°åœ–é é¢...`;
                this.contentElement.appendChild(countdownElement);

                const interval = setInterval(() => {
                    seconds--;
                    if (seconds > 0) {
                        countdownElement.textContent = `${seconds} ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°åœ°åœ–é é¢...`;
                    } else {
                        clearInterval(interval);
                        window.location.href = 'index.html';
                    }
                }, 1000);

                this.buttonsElement.style.display = 'block';
            }

            showManualProcess(authCode) {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'ğŸ“‹ æ‰‹å‹•æˆæ¬Šæµç¨‹';
                
                this.contentElement.innerHTML = `
                    <div class="step">
                        <h3>æˆæ¬Šç¢¼å·²ç²å–</h3>
                        <p>ç”±æ–¼å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•åœ¨å‰ç«¯ç›´æ¥å®Œæˆä»¤ç‰Œäº¤æ›ã€‚è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®Œæˆæˆæ¬Šï¼š</p>
                    </div>
                    
                    <div class="step">
                        <h4>æ­¥é©Ÿ 1ï¼šè¤‡è£½æˆæ¬Šç¢¼</h4>
                        <p>ä»¥ä¸‹æ˜¯æ‚¨çš„ Instagram æˆæ¬Šç¢¼ï¼š</p>
                    </div>
                `;

                this.codeElement.textContent = authCode;
                this.codeElement.style.display = 'block';

                this.contentElement.innerHTML += `
                    <div class="step">
                        <h4>æ­¥é©Ÿ 2ï¼šç²å–è¨ªå•ä»¤ç‰Œ</h4>
                        <p>ä½¿ç”¨ä»¥ä¸‹ curl å‘½ä»¤æˆ–å¾Œç«¯ API ä¾†äº¤æ›è¨ªå•ä»¤ç‰Œï¼š</p>
                    </div>
                `;

                const curlCommand = `curl -X POST \\
  https://api.instagram.com/oauth/access_token \\
  -F client_id=${INSTAGRAM_CONFIG.clientId} \\
  -F client_secret=${INSTAGRAM_CONFIG.clientSecret} \\
  -F grant_type=authorization_code \\
  -F redirect_uri=${INSTAGRAM_CONFIG.redirectUri} \\
  -F code=${authCode}`;

                const curlElement = document.createElement('div');
                curlElement.className = 'code-display';
                curlElement.style.display = 'block';
                curlElement.textContent = curlCommand;
                this.contentElement.appendChild(curlElement);

                this.contentElement.innerHTML += `
                    <div class="step">
                        <h4>æ­¥é©Ÿ 3ï¼šé…ç½®è¨ªå•ä»¤ç‰Œ</h4>
                        <p>ç²å¾—è¨ªå•ä»¤ç‰Œå¾Œï¼Œè«‹åœ¨ä¸»é é¢çš„ config.js æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„ä»¤ç‰Œã€‚</p>
                    </div>
                `;

                this.buttonsElement.style.display = 'block';
            }

            async exchangeCodeForToken(code) {
                try {
                    // æ³¨æ„ï¼šé€™å€‹æ–¹æ³•åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­éœ€è¦å¾Œç«¯æ”¯æŒ
                    // é€™è£¡æä¾›ä¸€å€‹æ¨¡æ“¬çš„å¯¦ç¾ç”¨æ–¼æ¼”ç¤º

                    this.updateStatus('æ­£åœ¨äº¤æ›è¨ªå•ä»¤ç‰Œ...');

                    // æ¨¡æ“¬ API èª¿ç”¨å»¶é²
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // å¯¦éš›å¯¦ç¾ä¸­ï¼Œé€™æ‡‰è©²æ˜¯ä¸€å€‹å°å¾Œç«¯ API çš„èª¿ç”¨
                    const formData = new FormData();
                    formData.append('client_id', INSTAGRAM_CONFIG.clientId);
                    formData.append('client_secret', INSTAGRAM_CONFIG.clientSecret);
                    formData.append('grant_type', 'authorization_code');
                    formData.append('redirect_uri', INSTAGRAM_CONFIG.redirectUri);
                    formData.append('code', code);

                    // é€™å€‹è«‹æ±‚æœƒå› ç‚º CORS æ”¿ç­–è€Œå¤±æ•—ï¼Œé€™æ˜¯æ­£å¸¸çš„
                    const response = await fetch('https://api.instagram.com/oauth/access_token', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const tokenData = await response.json();
                        return await this.exchangeForLongLivedToken(tokenData.access_token);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('ä»¤ç‰Œäº¤æ›å¤±æ•—:', error);
                    
                    // å¦‚æœè‡ªå‹•äº¤æ›å¤±æ•—ï¼Œåˆ‡æ›åˆ°æ‰‹å‹•æµç¨‹
                    this.showManualProcess(code);
                    return null;
                }
            }

            async exchangeForLongLivedToken(shortLivedToken) {
                try {
                    this.updateStatus('æ­£åœ¨ç²å–é•·æœŸè¨ªå•ä»¤ç‰Œ...');

                    const response = await fetch(
                        `${INSTAGRAM_CONFIG.baseURL}/access_token?grant_type=ig_exchange_token&client_secret=${INSTAGRAM_CONFIG.clientSecret}&access_token=${shortLivedToken}`
                    );

                    if (response.ok) {
                        const tokenData = await response.json();
                        
                        // ä¿å­˜ä»¤ç‰Œåˆ°æœ¬åœ°å­˜å„²
                        localStorage.setItem('instagram_access_token', tokenData.access_token);
                        
                        const expiryDate = new Date();
                        expiryDate.setDate(expiryDate.getDate() + Math.floor(tokenData.expires_in / 86400));
                        localStorage.setItem('instagram_token_expiry', expiryDate.toISOString());

                        return tokenData;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('é•·æœŸä»¤ç‰Œäº¤æ›å¤±æ•—:', error);
                    throw error;
                }
            }
        }

        // åˆå§‹åŒ–æˆæ¬Šè™•ç†
        async function initializeAuth() {
            const authHandler = new AuthHandler();
            const urlParams = new URLSearchParams(window.location.search);
            
            // æª¢æŸ¥éŒ¯èª¤åƒæ•¸
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            if (error) {
                authHandler.showError(error, errorDescription);
                return;
            }

            // æª¢æŸ¥æˆæ¬Šç¢¼
            const code = urlParams.get('code');
            
            if (!code) {
                authHandler.showError('æ²’æœ‰æ”¶åˆ°æˆæ¬Šç¢¼', 'è«‹ç¢ºèªæ‚¨å·²å®Œæˆ Instagram æˆæ¬Šæµç¨‹');
                return;
            }

            try {
                authHandler.updateStatus('æ­£åœ¨è™•ç†æˆæ¬Šç¢¼...');
                
                // å˜—è©¦è‡ªå‹•äº¤æ›ä»¤ç‰Œ
                const tokenData = await authHandler.exchangeCodeForToken(code);
                
                if (tokenData) {
                    authHandler.showSuccess(tokenData);
                }
                // å¦‚æœå¤±æ•—ï¼ŒexchangeCodeForToken æœƒè‡ªå‹•åˆ‡æ›åˆ°æ‰‹å‹•æµç¨‹
                
            } catch (error) {
                console.error('æˆæ¬Šè™•ç†å¤±æ•—:', error);
                authHandler.showError(error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeAuth);

        // è¤‡è£½æˆæ¬Šç¢¼åŠŸèƒ½
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                // å‚™ç”¨è¤‡è£½æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
            });
        }

        // ç‚ºä»£ç¢¼å€å¡Šæ·»åŠ é»æ“Šè¤‡è£½åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('code-display')) {
                copyToClipboard(e.target.textContent);
            }
        });
    </script>
</body>
</html>
