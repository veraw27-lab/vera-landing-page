<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Authorization - Vera's Travel Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .code-display {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 20px 0;
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #E4405F, #F77737);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .error {
            background: rgba(220, 53, 69, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: rgba(40, 167, 69, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .step {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #E4405F;
            text-align: left;
        }

        .countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <h1 id="pageTitle">ğŸ” è™•ç† Instagram æˆæ¬Š</h1>
        <div class="status-message" id="statusMessage">æ­£åœ¨è™•ç†æ‚¨çš„ Instagram æˆæ¬Š...</div>
        
        <div id="contentArea">
            <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>

        <div class="code-display" id="codeDisplay"></div>

        <div id="actionButtons" style="display: none;">
            <a href="index.html" class="btn">ğŸ—ºï¸ å‰å¾€åœ°åœ–</a>
            <button onclick="location.reload()" class="btn btn-secondary">ğŸ”„ é‡è©¦</button>
        </div>
    </div>

    <script>
        // âš ï¸ å®‰å…¨é…ç½®ï¼šåƒ…åŒ…å«å‰ç«¯å®‰å…¨ä¿¡æ¯
        const INSTAGRAM_CONFIG = {
            clientId: '1056166989953102', // å…¬é–‹ ID - å¯ä»¥å®‰å…¨æš´éœ²
            redirectUri: window.location.origin + window.location.pathname,
            baseURL: 'https://graph.instagram.com',
            
            // å¾Œç«¯ API ç«¯é»é…ç½®
            backendAPI: {
                tokenExchange: '/api/instagram/token-exchange', // éœ€è¦å¯¦ç¾çš„å¾Œç«¯ç«¯é»
                longLivedToken: '/api/instagram/long-lived-token' // é•·æœŸä»¤ç‰Œäº¤æ›ç«¯é»
            }
            
            // âŒ å·²ç§»é™¤ clientSecret - çµ•ä¸æ‡‰è©²åœ¨å‰ç«¯æš´éœ²
            // clientSecret: 'REMOVED_FOR_SECURITY' 
        };

        // æˆæ¬Šè™•ç†é¡
        class AuthHandler {
            constructor() {
                this.statusElement = document.getElementById('statusMessage');
                this.contentElement = document.getElementById('contentArea');
                this.codeElement = document.getElementById('codeDisplay');
                this.buttonsElement = document.getElementById('actionButtons');
                this.spinnerElement = document.getElementById('spinner');
            }

            updateStatus(message, isError = false) {
                this.statusElement.textContent = message;
                if (isError) {
                    this.statusElement.style.color = '#FFB6C1';
                } else {
                    this.statusElement.style.color = 'white';
                }
            }

            showError(message, details = '') {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'âŒ æˆæ¬Šå¤±æ•—';
                
                this.contentElement.innerHTML = `
                    <div class="error">
                        <h3>æˆæ¬Šéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤</h3>
                        <p><strong>éŒ¯èª¤ä¿¡æ¯ï¼š</strong>${message}</p>
                        ${details ? `<p><strong>è©³ç´°ä¿¡æ¯ï¼š</strong>${details}</p>` : ''}
                    </div>
                    <div class="step">
                        <h4>å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                        <ul style="text-align: left; margin-left: 20px;">
                            <li>ç¢ºèªæ‚¨çš„ Instagram æ‡‰ç”¨é…ç½®æ­£ç¢º</li>
                            <li>æª¢æŸ¥é‡å®šå‘ URI æ˜¯å¦åŒ¹é…</li>
                            <li>ç¢ºèªæ‡‰ç”¨æ¬Šé™è¨­ç½®æ­£ç¢º</li>
                            <li>å˜—è©¦é‡æ–°é–‹å§‹æˆæ¬Šæµç¨‹</li>
                        </ul>
                    </div>
                `;
                
                this.buttonsElement.style.display = 'block';
            }

            showSuccess(tokenData) {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'âœ… æˆæ¬ŠæˆåŠŸ';
                
                this.contentElement.innerHTML = `
                    <div class="success">
                        <h3>Instagram æˆæ¬Šå®Œæˆï¼</h3>
                        <p>æ‚¨çš„è¨ªå•ä»¤ç‰Œå·²å®‰å…¨ä¿å­˜ï¼Œç¾åœ¨å¯ä»¥è¨ªå•æ‚¨çš„ Instagram æ•¸æ“šã€‚</p>
                    </div>
                    <div class="step">
                        <h4>æˆæ¬Šä¿¡æ¯ï¼š</h4>
                        <p><strong>ç”¨æˆ¶ IDï¼š</strong>${tokenData.user_id || 'N/A'}</p>
                        <p><strong>ä»¤ç‰Œé¡å‹ï¼š</strong>é•·æœŸè¨ªå•ä»¤ç‰Œ</p>
                        <p><strong>æœ‰æ•ˆæœŸï¼š</strong>60 å¤©</p>
                        <p><strong>æ¬Šé™ï¼š</strong>ç”¨æˆ¶è³‡æ–™, ç”¨æˆ¶åª’é«”</p>
                    </div>
                `;

                // å€’æ•¸è¨ˆæ™‚è‡ªå‹•è·³è½‰
                this.startCountdown();
            }

            startCountdown() {
                let seconds = 5;
                const countdownElement = document.createElement('div');
                countdownElement.className = 'countdown';
                countdownElement.textContent = `${seconds} ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°åœ°åœ–é é¢...`;
                this.contentElement.appendChild(countdownElement);

                const interval = setInterval(() => {
                    seconds--;
                    if (seconds > 0) {
                        countdownElement.textContent = `${seconds} ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°åœ°åœ–é é¢...`;
                    } else {
                        clearInterval(interval);
                        window.location.href = 'index.html';
                    }
                }, 1000);

                this.buttonsElement.style.display = 'block';
            }

            showSecurityError(authCode, errorMessage) {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'ğŸ”’ éœ€è¦å®‰å…¨å¾Œç«¯æ”¯æŒ';
                
                this.contentElement.innerHTML = `
                    <div class="error">
                        <h3>å®‰å…¨é™åˆ¶ï¼šç„¡æ³•åœ¨å‰ç«¯å®Œæˆæˆæ¬Š</h3>
                        <p><strong>éŒ¯èª¤ä¿¡æ¯ï¼š</strong>${errorMessage}</p>
                        <p>ç‚ºäº†ä¿è­·æ‚¨çš„æ•¸æ“šå®‰å…¨ï¼ŒInstagram ä»¤ç‰Œäº¤æ›å¿…é ˆåœ¨å®‰å…¨çš„å¾Œç«¯ç’°å¢ƒä¸­é€²è¡Œã€‚</p>
                    </div>
                    
                    <div class="step">
                        <h4>ğŸ›¡ï¸ ç‚ºä»€éº¼éœ€è¦å¾Œç«¯ APIï¼Ÿ</h4>
                        <ul style="text-align: left; margin-left: 20px;">
                            <li><strong>ä¿è­·å®¢æˆ¶ç«¯å¯†é‘°ï¼š</strong>client_secret çµ•ä¸èƒ½æš´éœ²åœ¨å‰ç«¯ä»£ç¢¼ä¸­</li>
                            <li><strong>é˜²æ­¢ä»¤ç‰Œæ´©éœ²ï¼š</strong>é¿å…æ•æ„Ÿæ•¸æ“šåœ¨ç€è¦½å™¨ä¸­å‚³è¼¸</li>
                            <li><strong>ç¬¦åˆå®‰å…¨æ¨™æº–ï¼š</strong>éµå¾ª OAuth 2.0 å®‰å…¨æœ€ä½³å¯¦è¸</li>
                            <li><strong>æ¸›å°‘æ”»æ“Šé¢ï¼š</strong>é™ä½ CSRF å’Œä¸­é–“äººæ”»æ“Šé¢¨éšª</li>
                        </ul>
                    </div>
                    
                    <div class="step">
                        <h4>ğŸš€ å»ºè­°çš„è§£æ±ºæ–¹æ¡ˆ</h4>
                        <p>è«‹å¯¦ç¾ä»¥ä¸‹å¾Œç«¯ API ç«¯é»ï¼š</p>
                        <ul style="text-align: left; margin-left: 20px;">
                            <li><code>/api/instagram/token-exchange</code> - å®‰å…¨ä»¤ç‰Œäº¤æ›</li>
                            <li><code>/api/instagram/long-lived-token</code> - é•·æœŸä»¤ç‰Œç²å–</li>
                            <li>ä½¿ç”¨ Netlify Functionsã€Vercel API æˆ–å…¶ä»–ç„¡æœå‹™å™¨è§£æ±ºæ–¹æ¡ˆ</li>
                        </ul>
                    </div>
                    
                    <div class="step">
                        <h4>ğŸ“‹ æ‚¨çš„æˆæ¬Šç¢¼ï¼ˆåƒ…ä¾›è‡¨æ™‚ä½¿ç”¨ï¼‰</h4>
                        <p>åœ¨å¾Œç«¯ API æº–å‚™å¥½ä¹‹å‰ï¼Œæ‚¨å¯ä»¥è‡¨æ™‚ä½¿ç”¨æ­¤æˆæ¬Šç¢¼ï¼š</p>
                    </div>
                `;

                this.codeElement.textContent = authCode;
                this.codeElement.style.display = 'block';

                this.buttonsElement.style.display = 'block';
            }

            showManualProcess(authCode) {
                this.spinnerElement.style.display = 'none';
                document.getElementById('pageTitle').textContent = 'ğŸ“‹ å®‰å…¨æˆæ¬Šæµç¨‹';
                
                this.contentElement.innerHTML = `
                    <div class="step">
                        <h3>ğŸ”’ æˆæ¬Šç¢¼å·²å®‰å…¨ç²å–</h3>
                        <p>ç”±æ–¼å®‰å…¨è€ƒæ…®ï¼Œå‰ç«¯ç„¡æ³•ç›´æ¥å®Œæˆä»¤ç‰Œäº¤æ›ã€‚è«‹ä½¿ç”¨å®‰å…¨çš„å¾Œç«¯ç’°å¢ƒå®Œæˆæ­¤æµç¨‹ã€‚</p>
                    </div>
                    
                    <div class="step">
                        <h4>æ­¥é©Ÿ 1ï¼šè¤‡è£½æˆæ¬Šç¢¼</h4>
                        <p>ä»¥ä¸‹æ˜¯æ‚¨çš„ Instagram æˆæ¬Šç¢¼ï¼ˆé»æ“Šå¯è¤‡è£½ï¼‰ï¼š</p>
                    </div>
                `;

                this.codeElement.textContent = authCode;
                this.codeElement.style.display = 'block';
                this.codeElement.style.cursor = 'pointer';
                this.codeElement.title = 'é»æ“Šè¤‡è£½';

                this.contentElement.innerHTML += `
                    <div class="step">
                        <h4>æ­¥é©Ÿ 2ï¼šå®‰å…¨ä»¤ç‰Œäº¤æ›</h4>
                        <p><strong>âš ï¸ é‡è¦ï¼š</strong>ä»¤ç‰Œäº¤æ›å¿…é ˆåœ¨å¾Œç«¯é€²è¡Œï¼Œçµ•ä¸èƒ½åœ¨å‰ç«¯æš´éœ² client_secretã€‚</p>
                        <p>è«‹ä½¿ç”¨æ‚¨çš„å¾Œç«¯ API æˆ–ä»¥ä¸‹å®‰å…¨ç’°å¢ƒä¹‹ä¸€ï¼š</p>
                        <ul style="text-align: left; margin-left: 20px;">
                            <li>Netlify Functions</li>
                            <li>Vercel API Routes</li>
                            <li>AWS Lambda</li>
                            <li>å®‰å…¨çš„æœå‹™å™¨ç’°å¢ƒ</li>
                        </ul>
                    </div>
                    
                    <div class="step">
                        <h4>æ­¥é©Ÿ 3ï¼šé…ç½®è¨ªå•ä»¤ç‰Œ</h4>
                        <p>ç²å¾—è¨ªå•ä»¤ç‰Œå¾Œï¼Œè«‹åœ¨æ‡‰ç”¨ä¸­å®‰å…¨åœ°ä½¿ç”¨å®ƒä¾†è¨ªå• Instagram APIã€‚</p>
                        <p><strong>å®‰å…¨æç¤ºï¼š</strong>ä½¿ç”¨ sessionStorage è€Œé localStorage å­˜å„²ä»¤ç‰Œã€‚</p>
                    </div>
                `;

                this.buttonsElement.style.display = 'block';
            }

            async exchangeCodeForToken(code) {
                try {
                    this.updateStatus('æ­£åœ¨äº¤æ›è¨ªå•ä»¤ç‰Œ...');

                    // ğŸ”’ å®‰å…¨å¯¦ç¾ï¼šä½¿ç”¨å¾Œç«¯ API é€²è¡Œä»¤ç‰Œäº¤æ›
                    // é¿å…åœ¨å‰ç«¯æš´éœ² client_secret
                    
                    const response = await fetch(INSTAGRAM_CONFIG.backendAPI.tokenExchange, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            code: code,
                            redirect_uri: INSTAGRAM_CONFIG.redirectUri
                        })
                    });

                    if (response.ok) {
                        const tokenData = await response.json();
                        
                        // ğŸ”’ ä½¿ç”¨ sessionStorage è€Œé localStorage æé«˜å®‰å…¨æ€§
                        // sessionStorage åœ¨æ¨™ç±¤é é—œé–‰æ™‚è‡ªå‹•æ¸…é™¤
                        sessionStorage.setItem('instagram_access_token', tokenData.access_token);
                        
                        if (tokenData.expires_in) {
                            const expiryDate = new Date();
                            expiryDate.setSeconds(expiryDate.getSeconds() + tokenData.expires_in);
                            sessionStorage.setItem('instagram_token_expiry', expiryDate.toISOString());
                        }
                        
                        // ä¿å­˜ç”¨æˆ¶ä¿¡æ¯
                        if (tokenData.user_id) {
                            sessionStorage.setItem('instagram_user_id', tokenData.user_id);
                        }

                        return tokenData;
                    } else {
                        throw new Error(`å¾Œç«¯ API éŒ¯èª¤: HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('å®‰å…¨ä»¤ç‰Œäº¤æ›å¤±æ•—:', error);
                    
                    // é¡¯ç¤ºå®‰å…¨éŒ¯èª¤ä¿¡æ¯ï¼Œå»ºè­°è¨­ç½®å¾Œç«¯ API
                    this.showSecurityError(code, error.message);
                    return null;
                }
            }

            async exchangeForLongLivedToken(shortLivedToken) {
                try {
                    this.updateStatus('æ­£åœ¨ç²å–é•·æœŸè¨ªå•ä»¤ç‰Œ...');

                    // ğŸ”’ å®‰å…¨å¯¦ç¾ï¼šä½¿ç”¨å¾Œç«¯ API é€²è¡Œé•·æœŸä»¤ç‰Œäº¤æ›
                    const response = await fetch(INSTAGRAM_CONFIG.backendAPI.longLivedToken, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            access_token: shortLivedToken
                        })
                    });

                    if (response.ok) {
                        const tokenData = await response.json();
                        
                        // ğŸ”’ ä½¿ç”¨ sessionStorage æ›´æ–°ä»¤ç‰Œ
                        sessionStorage.setItem('instagram_access_token', tokenData.access_token);
                        
                        if (tokenData.expires_in) {
                            const expiryDate = new Date();
                            expiryDate.setSeconds(expiryDate.getSeconds() + tokenData.expires_in);
                            sessionStorage.setItem('instagram_token_expiry', expiryDate.toISOString());
                        }

                        return tokenData;
                    } else {
                        throw new Error(`å¾Œç«¯ API éŒ¯èª¤: HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('é•·æœŸä»¤ç‰Œäº¤æ›å¤±æ•—:', error);
                    throw error;
                }
            }
        }

        // åˆå§‹åŒ–æˆæ¬Šè™•ç†
        async function initializeAuth() {
            const authHandler = new AuthHandler();
            const urlParams = new URLSearchParams(window.location.search);
            
            // æª¢æŸ¥éŒ¯èª¤åƒæ•¸
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            if (error) {
                authHandler.showError(error, errorDescription);
                return;
            }

            // æª¢æŸ¥æˆæ¬Šç¢¼
            const code = urlParams.get('code');
            
            if (!code) {
                authHandler.showError('æ²’æœ‰æ”¶åˆ°æˆæ¬Šç¢¼', 'è«‹ç¢ºèªæ‚¨å·²å®Œæˆ Instagram æˆæ¬Šæµç¨‹');
                return;
            }

            try {
                authHandler.updateStatus('æ­£åœ¨è™•ç†æˆæ¬Šç¢¼...');
                
                // å˜—è©¦è‡ªå‹•äº¤æ›ä»¤ç‰Œ
                const tokenData = await authHandler.exchangeCodeForToken(code);
                
                if (tokenData) {
                    authHandler.showSuccess(tokenData);
                }
                // å¦‚æœå¤±æ•—ï¼ŒexchangeCodeForToken æœƒè‡ªå‹•åˆ‡æ›åˆ°æ‰‹å‹•æµç¨‹
                
            } catch (error) {
                console.error('æˆæ¬Šè™•ç†å¤±æ•—:', error);
                authHandler.showError(error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeAuth);

        // ğŸ”’ å®‰å…¨æ¸…ç†ï¼šæ¨™ç±¤é é—œé–‰æ™‚æ¸…é™¤æ•æ„Ÿæ•¸æ“š
        window.addEventListener('beforeunload', () => {
            // æ¸…é™¤æ‰€æœ‰ Instagram ç›¸é—œçš„ session æ•¸æ“š
            sessionStorage.removeItem('instagram_access_token');
            sessionStorage.removeItem('instagram_token_expiry');
            sessionStorage.removeItem('instagram_user_id');
        });

        // ğŸ”’ å®‰å…¨ç›£æ§ï¼šæª¢æ¸¬ç•°å¸¸æ´»å‹•
        window.addEventListener('focus', () => {
            // ç•¶é é¢é‡æ–°ç²å¾—ç„¦é»æ™‚ï¼Œæª¢æŸ¥ä»¤ç‰Œæ˜¯å¦ä»ç„¶æœ‰æ•ˆ
            const token = sessionStorage.getItem('instagram_access_token');
            const expiry = sessionStorage.getItem('instagram_token_expiry');
            
            if (token && expiry) {
                const expiryDate = new Date(expiry);
                if (expiryDate <= new Date()) {
                    // ä»¤ç‰Œå·²éæœŸï¼Œæ¸…é™¤ä¸¦æç¤ºç”¨æˆ¶
                    sessionStorage.clear();
                    console.warn('Instagram ä»¤ç‰Œå·²éæœŸï¼Œå·²è‡ªå‹•æ¸…é™¤');
                }
            }
        });

        // è¤‡è£½æˆæ¬Šç¢¼åŠŸèƒ½
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                // å‚™ç”¨è¤‡è£½æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
            });
        }

        // ç‚ºä»£ç¢¼å€å¡Šæ·»åŠ é»æ“Šè¤‡è£½åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('code-display')) {
                copyToClipboard(e.target.textContent);
            }
        });
    </script>
</body>
</html>
