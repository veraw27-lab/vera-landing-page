<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vera's Travel Map</title>
    <!-- 加入 d3.js 與 topojson CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #ffffff;
            overflow: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            z-index: 1000;
            border-bottom: 1px solid #333333;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
        }

        .stats {
            display: flex;
            gap: 25px;
            font-size: 14px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 22px;
            font-weight: bold;
            color: #ffffff;
        }

        .stat-label {
            color: #888888;
            margin-top: 2px;
        }

        .map-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000000;
            position: relative;
            padding-top: 80px;
        }

        #world-map {
            width: 85%;
            height: 75%;
            max-width: 1200px;
            max-height: 700px;
        }

        .country {
            fill: #222222;
            stroke: #444444;
            stroke-width: 0.5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .country:hover {
            fill: #333333;
            stroke: #666666;
            stroke-width: 1;
        }

        .country.visited {
            fill: #666666;
            stroke: #888888;
            stroke-width: 1.5;
        }

        .country.visited:hover {
            fill: #888888;
            stroke: #aaaaaa;
            stroke-width: 2;
        }

        .country.high-activity {
            fill: #aaaaaa;
            stroke: #cccccc;
        }

        .country.country-highlight {
            fill: #555555 !important;
            stroke: #777777 !important;
            stroke-width: 2 !important;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #444444;
            z-index: 1001;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
            color: #ffffff;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333333;
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .posts-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            overflow-y: auto;
            padding: 80px 20px 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .posts-modal.show {
            opacity: 1;
        }

        .posts-content {
            max-width: 1000px;
            margin: 0 auto;
        }

        .posts-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .posts-title {
            font-size: 28px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .posts-subtitle {
            color: #888888;
            font-size: 16px;
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .post-card {
            background: #111111;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #333333;
        }

        .post-card:hover {
            transform: translateY(-3px);
            border-color: #666666;
            box-shadow: 0 10px 25px rgba(255, 255, 255, 0.1);
        }

        .post-image {
            width: 100%;
            height: 180px;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #888888;
        }

        .post-image.error {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            color: #ff6666;
            font-size: 16px;
            flex-direction: column;
            padding: 10px;
        }

        .error-photo {
            position: absolute;
            background: rgba(255, 68, 68, 0.3) !important;
            border: 2px solid #ff4444 !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: #fff !important;
            font-size: 12px !important;
            text-align: center !important;
            font-weight: bold !important;
        }

        .post-content {
            padding: 15px;
        }

        .post-location {
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .post-date {
            color: #888888;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .post-caption {
            color: #cccccc;
            line-height: 1.4;
            font-size: 14px;
        }

        .close-btn {
            position: fixed;
            top: 30px;
            right: 30px;
            background: #333333;
            border: 1px solid #666666;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            z-index: 3001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #666666;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333333;
        }

        .legend-title {
            color: white;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 2px;
        }

        .photo-burst {
            position: absolute;
            pointer-events: none;
            left: 0; top: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2001;
        }
        .photo-burst-img {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 15px;
            object-fit: cover;
            opacity: 0;
            transform: scale(0.7);
            transition: all 0.5s cubic-bezier(.4,2,.6,1);
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 6px 20px rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
        }
        .photo-burst-img:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255,255,255,0.2);
            z-index: 3003;
        }
        .photo-burst-img.visible {
            opacity: 1;
            transform: scale(1);
        }
        .photo-burst-img.visible:hover {
            transform: scale(1.1);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== 響應式設計 - 各裝置最佳化 ===== */
        
        /* 大螢幕桌機 (1400px+) */
        @media (min-width: 1400px) {
            .header-content {
                max-width: 1600px;
            }
            
            #world-map {
                width: 90%;
                height: 80%;
                max-width: 1400px;
                max-height: 800px;
            }
            
            .photo-burst-img {
                width: 100px;
                height: 100px;
            }
            
            .legend {
                bottom: 30px;
                left: 30px;
                padding: 20px;
            }
        }
        
        /* 標準桌機 (1024px - 1399px) */
        @media (min-width: 1024px) and (max-width: 1399px) {
            #world-map {
                width: 88%;
                height: 78%;
            }
            
            .stats {
                gap: 30px;
            }
            
            .stat-number {
                font-size: 24px;
            }
        }
        
        /* 平板橫向 (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .header {
                padding: 12px 20px;
            }
            
            .header-content {
                max-width: 100%;
            }
            
            .logo {
                font-size: 22px;
            }
            
            .stats {
                gap: 20px;
            }
            
            .stat-number {
                font-size: 20px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            #world-map {
                width: 95%;
                height: 70%;
                max-width: 900px;
                max-height: 600px;
            }
            
            .map-container {
                padding-top: 70px;
            }
            
            .photo-burst-img {
                width: 80px;
                height: 80px;
                border-radius: 12px;
            }
            
            .legend {
                bottom: 15px;
                left: 15px;
                padding: 12px;
                font-size: 11px;
            }
            
            .legend-title {
                font-size: 12px;
                margin-bottom: 8px;
            }
            
            .legend-item {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .legend-color {
                width: 12px;
                height: 12px;
            }
            
            .posts-modal {
                padding: 70px 20px 20px;
            }
            
            .posts-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }
            
            .posts-title {
                font-size: 24px;
            }
            
            .posts-subtitle {
                font-size: 14px;
            }
        }
        
        /* 平板直向 & 大手機 (481px - 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            .header {
                padding: 10px 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }
            
            .logo {
                font-size: 20px;
                margin-bottom: 5px;
            }
            
            .stats {
                gap: 20px;
                justify-content: center;
            }
            
            .stat-number {
                font-size: 18px;
            }
            
            .stat-label {
                font-size: 11px;
            }
            
            #world-map {
                width: 98%;
                height: 65%;
                max-width: 700px;
                max-height: 500px;
            }
            
            .map-container {
                padding-top: 90px;
            }
            
            .photo-burst-img {
                width: 70px;
                height: 70px;
                border-radius: 10px;
            }
            
            .legend {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                font-size: 10px;
            }
            
            .legend-title {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .legend-item {
                font-size: 9px;
                margin-bottom: 3px;
                gap: 6px;
            }
            
            .legend-color {
                width: 10px;
                height: 10px;
            }
            
            .legend-help {
                font-size: 9px;
                margin-top: 8px;
            }
            
            .posts-modal {
                padding: 90px 15px 15px;
            }
            
            .posts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .posts-title {
                font-size: 22px;
            }
            
            .posts-subtitle {
                font-size: 13px;
            }
            
            .post-image {
                height: 160px;
            }
            
            .tooltip {
                font-size: 12px;
                padding: 6px 10px;
            }
        }
        
        /* 小手機 (≤480px) */
        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .logo {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .stats {
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .stat-item {
                min-width: 60px;
            }
            
            .stat-number {
                font-size: 16px;
            }
            
            .stat-label {
                font-size: 10px;
            }
            
            #world-map {
                width: 100%;
                height: 60%;
                max-width: 100%;
                max-height: 400px;
            }
            
            .map-container {
                padding-top: 100px;
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .photo-burst-img {
                width: 60px;
                height: 60px;
                border-radius: 8px;
                border-width: 1px;
            }
            
            .legend {
                bottom: 5px;
                left: 5px;
                padding: 8px;
                font-size: 9px;
                max-width: 140px;
            }
            
            .legend-title {
                font-size: 10px;
                margin-bottom: 5px;
            }
            
            .legend-item {
                font-size: 8px;
                margin-bottom: 2px;
                gap: 4px;
            }
            
            .legend-color {
                width: 8px;
                height: 8px;
            }
            
            .legend-help {
                font-size: 7px;
                margin-top: 6px;
                line-height: 1.2;
            }
            
            .posts-modal {
                padding: 100px 10px 10px;
            }
            
            .posts-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .posts-title {
                font-size: 20px;
            }
            
            .posts-subtitle {
                font-size: 12px;
            }
            
            .post-image {
                height: 140px;
            }
            
            .post-content {
                padding: 12px;
            }
            
            .post-location {
                font-size: 14px;
            }
            
            .post-date {
                font-size: 11px;
            }
            
            .post-caption {
                font-size: 12px;
                line-height: 1.3;
            }
            
            .close-btn {
                top: 20px;
                right: 20px;
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .tooltip {
                font-size: 11px;
                padding: 5px 8px;
                max-width: 200px;
            }
        }
        
        /* 極小螢幕 (≤320px) */
        @media (max-width: 320px) {
            .header {
                padding: 6px 8px;
            }
            
            .logo {
                font-size: 16px;
            }
            
            .stats {
                gap: 10px;
            }
            
            .stat-number {
                font-size: 14px;
            }
            
            .stat-label {
                font-size: 9px;
            }
            
            #world-map {
                height: 55%;
                max-height: 350px;
            }
            
            .map-container {
                padding-top: 110px;
            }
            
            .photo-burst-img {
                width: 50px;
                height: 50px;
            }
            
            .legend {
                bottom: 3px;
                left: 3px;
                padding: 6px;
                max-width: 120px;
            }
            
            .posts-title {
                font-size: 18px;
            }
            
            .close-btn {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }
        
        /* 橫向模式優化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .map-container {
                padding-top: 60px;
            }
            
            #world-map {
                height: 85%;
            }
            
            .legend {
                bottom: 8px;
                font-size: 8px;
                padding: 6px;
            }
            
            .header {
                padding: 6px 15px;
            }
            
            .stats {
                gap: 12px;
            }
            
            .stat-number {
                font-size: 14px;
            }
        }
        
        /* 觸控裝置優化 */
        @media (hover: none) and (pointer: coarse) {
            .photo-burst-img {
                border-width: 3px;
                box-shadow: 0 4px 15px rgba(255,255,255,0.2);
            }
            
            .post-card {
                border-width: 2px;
            }
            
            .country {
                stroke-width: 1;
            }
            
            .country.visited {
                stroke-width: 2;
            }
            
            .tooltip {
                display: none; /* 觸控裝置不顯示 tooltip */
            }
        }
        
        /* 高解析度螢幕優化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .photo-burst-img {
                border-width: 0.5px;
            }
            
            .country {
                stroke-width: 0.25;
            }
            
            .country.visited {
                stroke-width: 0.75;
            }
        }

        /* 國家預覽抽屜 */
        .country-preview {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #333;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 2000;
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
        }

        .country-preview.show {
            transform: translateY(0);
        }

        .country-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .country-preview-title {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }

        .country-preview-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .country-preview-content {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .country-preview-stats {
            flex: 1;
        }

        .country-preview-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #ccc;
        }

        .country-preview-stat .label {
            color: #888;
        }

        .country-preview-stat .value {
            color: #fff;
            font-weight: bold;
        }

        .country-preview-photos {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .country-preview-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #444;
        }

        .country-preview-view-more {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s ease;
        }

        .country-preview-view-more:hover {
            transform: translateY(-1px);
        }

        .country-preview-view-more:active {
            transform: translateY(0);
        }

        /* 手機版地圖優化 */
        @media (max-width: 768px) {
            #world-map {
                width: 100%;
                height: 70vh;
                min-height: 500px;
                max-height: none;
            }

            .map-container {
                padding-top: 100px;
                padding-bottom: 20px;
                height: 100vh;
                align-items: flex-start;
            }

            /* 讓地圖可以放大 */
            .map-container svg {
                cursor: grab;
            }

            .map-container svg:active {
                cursor: grabbing;
            }

            /* 增大觸控目標 */
            .country {
                stroke-width: 1.5;
            }

            .country:hover, .country:active {
                stroke-width: 2.5;
            }

            /* 國家預覽抽屜手機版調整 */
            .country-preview {
                max-height: 50vh;
                padding: 15px;
            }

            .country-preview-content {
                flex-direction: column;
                gap: 15px;
            }

            .country-preview-photos {
                justify-content: center;
                flex-wrap: wrap;
            }

            .country-preview-photo {
                width: 50px;
                height: 50px;
            }
        }

        @media (max-width: 480px) {
            .country-preview-title {
                font-size: 20px;
            }

            .country-preview-photo {
                width: 45px;
                height: 45px;
            }

            .country-preview {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">🌍 Vera's Travel Map</div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="countries-count">0</span>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="cities-count">0</span>
                    <div class="stat-label">Cities</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="posts-count">0</span>
                    <div class="stat-label">Posts</div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Loading travel map...</div>
    </div>

    <div class="map-container">
        <svg id="world-map"></svg>
        <div class="legend">
            <div class="legend-title">Legend</div>
            <div class="legend-item">
                <div class="legend-color" style="background: #222222;"></div>
                <span style="color: #cccccc;">未造訪</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #666666;"></div>
                <span style="color: #cccccc;">已造訪</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #aaaaaa;"></div>
                <span style="color: #cccccc;">多次造訪</span>
            </div>
            <div class="legend-help" style="margin-top: 10px; font-size: 12px; color: #888; text-align: center;">
                懸停查看照片 • 點擊照片查看詳情
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- 桌面版爆破照片容器 -->
    <div class="photo-burst" id="photo-burst"></div>

    <div class="posts-modal" id="posts-modal">
        <button class="close-btn" onclick="closePosts()">×</button>
        <div class="posts-content">
            <div class="posts-header">
                <div class="posts-title" id="modal-title">Country Posts</div>
                <div class="posts-subtitle" id="modal-subtitle">Click any post to view on Instagram</div>
            </div>
            <div class="posts-grid" id="posts-grid"></div>
        </div>
    </div>

    <!-- 國家預覽抽屜 -->
    <div class="country-preview" id="country-preview">
        <div class="country-preview-header">
            <div class="country-preview-title" id="preview-title">國家名稱</div>
            <button class="country-preview-close" onclick="closeCountryPreview()">×</button>
        </div>
        <div class="country-preview-content">
            <div class="country-preview-stats">
                <div class="country-preview-stat">
                    <span class="label">Posts:</span>
                    <span class="value" id="preview-posts">0</span>
                </div>
                <div class="country-preview-stat">
                    <span class="label">Cities:</span>
                    <span class="value" id="preview-cities">0</span>
                </div>
                <div class="country-preview-stat">
                    <span class="label">Latest Visit:</span>
                    <span class="value" id="preview-latest">-</span>
                </div>
            </div>
            <div class="country-preview-photos" id="preview-photos">
                <!-- 照片會動態載入 -->
            </div>
        </div>
        <button class="country-preview-view-more" onclick="viewCountryDetails()">
            View All Posts
        </button>
    </div>

    <script>
        let travelData = null;
        let svg, projection, path;
        let worldGeoData = null;
        let processedCountries = new Set(); // Prevent duplicate clicks

        // 移除示例數據，只使用真實的Instagram數據

        // 簡化的世界地圖座標（主要國家輪廓）
        const worldGeometry = {
            "United States": "M158,206L130,206L130,157L180,157L235,157L235,190L280,190L280,240L158,240Z",
            "Japan": "M830,160L860,160L860,200L830,200Z M840,210L850,210L850,230L840,230Z",
            "France": "M450,160L480,160L485,190L470,200L445,195L445,170Z",
            "Taiwan": "M820,220L830,220L830,245L820,245Z",
            "United Kingdom": "M420,140L440,140L440,170L420,170Z M435,135L445,135L445,145L435,145Z",
            "Thailand": "M780,250L800,250L800,290L780,290Z",
            "Germany": "M460,150L485,150L485,180L460,180Z",
            "Italy": "M470,180L490,180L495,220L485,230L470,220Z",
            "Spain": "M420,190L460,190L460,220L420,220Z",
            "China": "M750,180L850,180L850,240L800,260L750,240Z",
            "India": "M680,220L750,220L750,280L680,280Z",
            "Australia": "M800,350L900,350L900,420L800,420Z",
            "Brazil": "M300,280L400,280L420,380L320,400L300,340Z",
            "Canada": "M100,100L300,100L300,160L100,160Z",
            "Russia": "M500,80L900,80L900,160L700,160L650,140L500,140Z",
            "Mexico": "M150,230L250,230L250,280L150,280Z",
            "South Korea": "M840,190L850,190L850,210L840,210Z",
            "Norway": "M460,100L480,100L480,150L460,150Z",
            "Sweden": "M480,100L500,100L500,150L480,150Z",
            "Finland": "M500,100L520,100L520,150L500,150Z"
        };

        async function init() {
            console.log('🚀 初始化旅行地圖...');
            try {
                await loadTravelData();
                await loadWorldGeoData();
                renderMap();
                updateStats();
                document.getElementById('loading').style.display = 'none';
                console.log('✅ 地圖載入完成');
            } catch (error) {
                console.error('❌ 載入失敗:', error);
                showError();
            }
        }

        // ISO 3166-1 alpha-3 對應英文國名
        function getCountryNameMap() {
            // 完整 ISO 3166-1 alpha-3 對應英文國名（世界所有國家）
            return {
                '004': 'Afghanistan',
                '008': 'Albania',
                '010': 'Antarctica',
                '012': 'Algeria',
                '016': 'American Samoa',
                '020': 'Andorra',
                '024': 'Angola',
                '028': 'Antigua and Barbuda',
                '031': 'Azerbaijan',
                '032': 'Argentina',
                '036': 'Australia',
                '040': 'Austria',
                '044': 'Bahamas',
                '048': 'Bahrain',
                '050': 'Bangladesh',
                '051': 'Armenia',
                '052': 'Barbados',
                '056': 'Belgium',
                '060': 'Bermuda',
                '064': 'Bhutan',
                '068': 'Bolivia',
                '070': 'Bosnia and Herzegovina',
                '072': 'Botswana',
                '074': 'Bouvet Island',
                '076': 'Brazil',
                '084': 'Belize',
                '086': 'British Indian Ocean Territory',
                '090': 'Solomon Islands',
                '092': 'British Virgin Islands',
                '096': 'Brunei',
                '100': 'Bulgaria',
                '104': 'Myanmar',
                '108': 'Burundi',
                '112': 'Belarus',
                '116': 'Cambodia',
                '120': 'Cameroon',
                '124': 'Canada',
                '132': 'Cape Verde',
                '136': 'Cayman Islands',
                '140': 'Central African Republic',
                '144': 'Sri Lanka',
                '148': 'Chad',
                '152': 'Chile',
                '156': 'China',
                '158': 'Taiwan',
                '162': 'Christmas Island',
                '166': 'Cocos (Keeling) Islands',
                '170': 'Colombia',
                '174': 'Comoros',
                '175': 'Mayotte',
                '178': 'Congo',
                '180': 'Democratic Republic of the Congo',
                '184': 'Cook Islands',
                '188': 'Costa Rica',
                '191': 'Croatia',
                '192': 'Cuba',
                '196': 'Cyprus',
                '203': 'Czechia',
                '204': 'Benin',
                '208': 'Denmark',
                '212': 'Dominica',
                '214': 'Dominican Republic',
                '218': 'Ecuador',
                '222': 'El Salvador',
                '226': 'Equatorial Guinea',
                '231': 'Ethiopia',
                '232': 'Eritrea',
                '233': 'Estonia',
                '234': 'Faroe Islands',
                '238': 'Falkland Islands',
                '239': 'South Georgia and the South Sandwich Islands',
                '242': 'Fiji',
                '246': 'Finland',
                '248': 'Åland Islands',
                '250': 'France',
                '254': 'French Guiana',
                '258': 'French Polynesia',
                '260': 'French Southern Territories',
                '262': 'Djibouti',
                '266': 'Gabon',
                '268': 'Georgia',
                '270': 'Gambia',
                '275': 'Palestine',
                '276': 'Germany',
                '288': 'Ghana',
                '292': 'Gibraltar',
                '296': 'Kiribati',
                '300': 'Greece',
                '304': 'Greenland',
                '308': 'Grenada',
                '312': 'Guadeloupe',
                '316': 'Guam',
                '320': 'Guatemala',
                '324': 'Guinea',
                '328': 'Guyana',
                '332': 'Haiti',
                '334': 'Heard Island and McDonald Islands',
                '336': 'Vatican City',
                '340': 'Honduras',
                '344': 'Hong Kong',
                '348': 'Hungary',
                '352': 'Iceland',
                '356': 'India',
                '360': 'Indonesia',
                '364': 'Iran',
                '368': 'Iraq',
                '372': 'Ireland',
                '376': 'Israel',
                '380': 'Italy',
                '384': 'Côte d’Ivoire',
                '388': 'Jamaica',
                '392': 'Japan',
                '398': 'Kazakhstan',
                '400': 'Jordan',
                '404': 'Kenya',
                '408': 'North Korea',
                '410': 'South Korea',
                '414': 'Kuwait',
                '417': 'Kyrgyzstan',
                '418': 'Laos',
                '422': 'Lebanon',
                '426': 'Lesotho',
                '428': 'Latvia',
                '430': 'Liberia',
                '434': 'Libya',
                '438': 'Liechtenstein',
                '440': 'Lithuania',
                '442': 'Luxembourg',
                '446': 'Macao',
                '450': 'Madagascar',
                '454': 'Malawi',
                '458': 'Malaysia',
                '462': 'Maldives',
                '466': 'Mali',
                '470': 'Malta',
                '474': 'Martinique',
                '478': 'Mauritania',
                '480': 'Mauritius',
                '484': 'Mexico',
                '492': 'Monaco',
                '496': 'Mongolia',
                '498': 'Moldova',
                '499': 'Montenegro',
                '500': 'Montserrat',
                '504': 'Morocco',
                '508': 'Mozambique',
                '512': 'Oman',
                '516': 'Namibia',
                '520': 'Nauru',
                '524': 'Nepal',
                '528': 'Netherlands',
                '531': 'Curaçao',
                '533': 'Aruba',
                '534': 'Sint Maarten',
                '535': 'Bonaire, Sint Eustatius and Saba',
                '540': 'New Caledonia',
                '548': 'Vanuatu',
                '554': 'New Zealand',
                '558': 'Nicaragua',
                '562': 'Niger',
                '566': 'Nigeria',
                '570': 'Niue',
                '574': 'Norfolk Island',
                '578': 'Norway',
                '580': 'Northern Mariana Islands',
                '581': 'United States Minor Outlying Islands',
                '583': 'Micronesia',
                '584': 'Marshall Islands',
                '585': 'Palau',
                '586': 'Pakistan',
                '591': 'Panama',
                '598': 'Papua New Guinea',
                '600': 'Paraguay',
                '604': 'Peru',
                '608': 'Philippines',
                '612': 'Pitcairn Islands',
                '616': 'Poland',
                '620': 'Portugal',
                '624': 'Guinea-Bissau',
                '626': 'Timor-Leste',
                '630': 'Puerto Rico',
                '634': 'Qatar',
                '638': 'Réunion',
                '642': 'Romania',
                '643': 'Russia',
                '646': 'Rwanda',
                '652': 'Saint Barthélemy',
                '654': 'Saint Helena, Ascension and Tristan da Cunha',
                '659': 'Saint Kitts and Nevis',
                '660': 'Anguilla',
                '662': 'Saint Lucia',
                '663': 'Saint Martin',
                '666': 'Saint Pierre and Miquelon',
                '670': 'Saint Vincent and the Grenadines',
                '674': 'San Marino',
                '678': 'Sao Tome and Principe',
                '682': 'Saudi Arabia',
                '686': 'Senegal',
                '688': 'Serbia',
                '690': 'Seychelles',
                '694': 'Sierra Leone',
                '702': 'Singapore',
                '703': 'Slovakia',
                '704': 'Vietnam',
                '705': 'Slovenia',
                '706': 'Somalia',
                '710': 'South Africa',
                '716': 'Zimbabwe',
                '724': 'Spain',
                '728': 'South Sudan',
                '729': 'Sudan',
                '732': 'Western Sahara',
                '740': 'Suriname',
                '744': 'Svalbard and Jan Mayen',
                '748': 'Eswatini',
                '752': 'Sweden',
                '756': 'Switzerland',
                '760': 'Syria',
                '762': 'Tajikistan',
                '764': 'Thailand',
                '768': 'Togo',
                '772': 'Tokelau',
                '776': 'Tonga',
                '780': 'Trinidad and Tobago',
                '784': 'United Arab Emirates',
                '788': 'Tunisia',
                '792': 'Turkey',
                '795': 'Turkmenistan',
                '796': 'Turks and Caicos Islands',
                '798': 'Tuvalu',
                '800': 'Uganda',
                '804': 'Ukraine',
                '807': 'North Macedonia',
                '818': 'Egypt',
                '826': 'United Kingdom',
                '831': 'Guernsey',
                '832': 'Jersey',
                '833': 'Isle of Man',
                '834': 'Tanzania',
                '840': 'United States',
                '850': 'United States Virgin Islands',
                '854': 'Burkina Faso',
                '858': 'Uruguay',
                '860': 'Uzbekistan',
                '862': 'Venezuela',
                '876': 'Wallis and Futuna',
                '882': 'Samoa',
                '887': 'Yemen',
                '894': 'Zambia'
            };
        }

        // 國家名稱正規化，參考清理過的數據做正確判斷
        function normalizeCountryName(name, post, cleanedCountries = null) {
            // 建立標準化對應表，基於我們清理過的數據
            const countryNormalizationMap = {
                // 大小寫變體
                'taiwan': 'Taiwan',
                'japan': 'Japan',
                'nepal': 'Nepal',
                'france': 'France',
                'portugal': 'Portugal',
                'thailand': 'Thailand',
                'peru': 'Peru',
                'belgium': 'Belgium',
                'italy': 'Italy',
                'germany': 'Germany',
                'sweden': 'Sweden',
                'norway': 'Norway',
                'finland': 'Finland',
                'switzerland': 'Switzerland',
                'netherlands': 'Netherlands',
                'luxembourg': 'Luxembourg',
                'iceland': 'Iceland',
                'bolivia': 'Bolivia',
                'mexico': 'Mexico',
                'cambodia': 'Cambodia',
                'malaysia': 'Malaysia',
                
                // 常見錯誤修正
                'macus': 'Macau',
                'xico': 'Mexico',
                'philippine': 'Philippines',
                
                // 地區到國家的映射
                'toscana': 'Italy',
                'provence': 'France',
                'hong kong': 'Hong Kong',
                
                // 標準化名稱
                'USA': 'United States',
                'US': 'United States',
                'U.S.A.': 'United States',
                'United States of America': 'United States',
                'UK': 'United Kingdom',
                'England': 'United Kingdom',
                'South Korea': 'South Korea',
                'Korea, Republic of': 'South Korea',
                'Republic of Korea': 'South Korea',
            };
            
            // 若有 GPS，優先用經緯度判斷國家
            if (post && post.location && post.location.coordinates && window.worldGeoData) {
                const [lng, lat] = [post.location.coordinates.lng, post.location.coordinates.lat];
                let foundCountry = '';
                for (const feature of window.worldGeoData.features) {
                    if (d3.geoContains(feature, [lng, lat])) {
                        foundCountry = feature.properties.name || feature.properties.NAME || '';
                        break;
                    }
                }
                if (foundCountry) {
                    // 對GPS推斷的國家也進行標準化
                    return countryNormalizationMap[foundCountry.toLowerCase()] || foundCountry;
                }
            }
            
            // 處理空值或無效值
            if (!name || name === 'null' || name === 'undefined' || name.trim() === '') {
                // 只有在現有數據中找不到時，才嘗試從 caption 推斷
                if (post && post.caption && cleanedCountries) {
                    const caption = post.caption.toLowerCase();
                    // 只在已知的清理過的國家中搜索
                    for (const country of cleanedCountries) {
                        if (caption.includes(country.toLowerCase())) {
                            return country;
                        }
                    }
                    // 檢查常見的關鍵詞映射
                    const keywordMap = {
                        'england': 'United Kingdom',
                        'usa': 'United States', 
                        'america': 'United States',
                        'china': 'China'
                    };
                    for (const [keyword, standardName] of Object.entries(keywordMap)) {
                        if (caption.includes(keyword) && cleanedCountries.includes(standardName)) {
                            return standardName;
                        }
                    }
                }
                return '';
            }
            
            // 標準化現有名稱
            const trimmedName = name.trim();
            const lowerName = trimmedName.toLowerCase();
            
            // 優先使用我們的標準化對應表
            if (countryNormalizationMap[lowerName]) {
                return countryNormalizationMap[lowerName];
            }
            if (countryNormalizationMap[trimmedName]) {
                return countryNormalizationMap[trimmedName];
            }
            
            // 如果提供了清理過的國家列表，檢查是否已存在
            if (cleanedCountries) {
                // 精確匹配
                if (cleanedCountries.includes(trimmedName)) {
                    return trimmedName;
                }
                // 大小寫不敏感匹配
                const matchedCountry = cleanedCountries.find(c => c.toLowerCase() === lowerName);
                if (matchedCountry) {
                    return matchedCountry;
                }
            }
            
            return trimmedName;
        }

        // 載入 travelData 時自動補齊新國家，並合併所有 posts
        async function loadTravelData() {
            try {
                // 嘗試從後端載入數據，添加版本號強制刷新緩存
                const timestamp = new Date().getTime();
                const response = await fetch(`./data/travel-data.json?v=${timestamp}`);
                if (response.ok) {
                    const data = await response.json();
                    travelData = data;
                    console.log('✅ 從後端載入旅行數據');
                    console.log('='.repeat(50));
                    console.log('🚀 DEBUG: 原始數據統計');
                    console.log('📊 原始數據國家數量:', Object.keys(data.countries).length);
                    console.log('📝 原始國家列表:', Object.keys(data.countries).sort());
                    console.log('='.repeat(50));
                } else {
                    throw new Error('Backend data not available');
                }
            } catch (error) {
                // 沒有數據時顯示錯誤
                console.error('❌ 無法載入旅行數據:', error);
                travelData = { countries: {} };
                showError();
                return;
            }
            // 合併所有 posts 到正規化後的國家
            if (travelData && travelData.countries) {
                // 獲取已清理的國家列表
                const cleanedCountries = Object.keys(travelData.countries);
                const merged = {};
                Object.values(travelData.countries).forEach(country => {
                    if (country.posts) {
                        country.posts.forEach(post => {
                            const norm = normalizeCountryName(
                                post.location && post.location.country,
                                post,
                                cleanedCountries  // 傳入清理過的國家列表
                            );
                            if (!norm) return; // 無法判斷國家
                            if (!merged[norm]) {
                                merged[norm] = {
                                    name: norm,
                                    posts: [],
                                    cities: []
                                };
                            }
                            // 避免重複加入
                            if (!merged[norm].posts.some(p => p.id === post.id)) {
                                merged[norm].posts.push(post);
                            }
                            if (post.location && post.location.city && !merged[norm].cities.includes(post.location.city)) {
                                merged[norm].cities.push(post.location.city);
                            }
                        });
                    }
                });
                travelData.countries = merged;
                console.log('='.repeat(50));
                console.log('🎯 DEBUG: 合併後統計');
                console.log('🔄 數據合併後國家數量:', Object.keys(merged).length);
                console.log('📝 合併後國家列表:', Object.keys(merged).sort());
                console.log('='.repeat(50));
                console.log('🎉 國家數量應該顯示:', Object.keys(merged).length);
                
                // 提供全局檢查函數
                window.checkCountryData = () => {
                    console.clear();
                    console.log('🔍 當前數據檢查:');
                    console.log('國家數量:', Object.keys(travelData.countries).length);
                    console.log('國家列表:', Object.keys(travelData.countries).sort());
                    return Object.keys(travelData.countries).length;
                };
            }
        }

        async function loadWorldGeoData() {
            // 使用 d3 直接載入 world-110m.json（CDN）
            // 來源: https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json
            const url = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';
            const res = await fetch(url);
            if (!res.ok) throw new Error('World map data load failed');
            const topo = await res.json();
            worldGeoData = topojson.feature(topo, topo.objects.countries);
            window.worldGeoData = worldGeoData; // 讓 normalizeCountryName 可用
        }

        // 載入國家地理中心表
let countryCenters = {};
(async function() {
  try {
    const res = await fetch('./js/country-centers.js');
    if (res.ok) {
      // 以 ESM 方式動態 import
      const text = await res.text();
      // 解析出物件
      // eslint-disable-next-line no-eval
      countryCenters = eval(text.replace('export const countryCenters =', ''));
    }
  } catch (e) {
    countryCenters = {};
  }
})();

        function renderMap() {
            const width = Math.min(window.innerWidth * 0.7, 900);
            const height = Math.min(window.innerHeight * 0.65, 600);
            svg = d3.select("#world-map")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`);
            svg.selectAll("*").remove();
            clearPhotoBurst();
            // 新增：清除舊的國家預覽圖層
            let previewLayer = document.getElementById('country-preview-layer');
            if (previewLayer) previewLayer.remove();
            previewLayer = document.createElement('div');
            previewLayer.id = 'country-preview-layer';
            previewLayer.style.position = 'absolute';
            previewLayer.style.left = '0';
            previewLayer.style.top = '0';
            previewLayer.style.width = '100%';
            previewLayer.style.height = '100%';
            previewLayer.style.pointerEvents = 'none';
            previewLayer.style.zIndex = 1002;
            document.querySelector('.map-container').appendChild(previewLayer);

            // 投影 - 縮小地圖，更簡潔的顯示
            projection = d3.geoMercator()
                .scale(width / 8)
                .translate([width / 2, height / 1.6]);
            path = d3.geoPath().projection(projection);

            // 添加手機觸控縮放支援
            const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
            if (isMobile) {
                const zoom = d3.zoom()
                    .scaleExtent([0.5, 3])  // 允許縮放範圍
                    .on("zoom", function(event) {
                        svg.select("g").attr("transform", event.transform);
                    });
                
                svg.call(zoom);
                
                // 添加雙擊重置縮放
                svg.on("dblclick.zoom", function(event) {
                    svg.transition().duration(750).call(
                        zoom.transform,
                        d3.zoomIdentity
                    );
                });
            }

            // 國家名稱對照表（ISO 3166-1 alpha-3 -> 英文國名）
            const countryNameMap = getCountryNameMap();

            const mapGroup = svg.append("g");
            
            mapGroup.selectAll("path")
                .data(worldGeoData.features)
                .join("path")
                .attr("d", d => {
                    // 不論有無對應國名都畫出來
                    return path(d);
                })
                .attr("class", d => {
                    const name = countryNameMap[d.id];
                    if (!name) {
                        // 沒有對應國名，仍然顯示為未造訪
                        return "country";
                    }
                    const visited = travelData.countries[name];
                    let className = "country";
                    if (visited) {
                        className += " visited";
                        if (visited.posts.length >= 2) className += " high-activity";
                    }
                    return className;
                })
                .attr("data-country", d => countryNameMap[d.id] || "")
                .on("mouseover", function(event, d) {
                    const currentLogicalName = countryNameMap[d.id];
                    if (!currentLogicalName) return;

                    // Clear all previous highlights first
                    svg.selectAll("path.country-highlight").classed("country-highlight", false);

                    if (currentLogicalName === "United States") {
                        svg.selectAll("path")
                            .filter(f => countryNameMap[f.id] === "United States" && f.properties.name === "United States of America")
                            .classed("country-highlight", true);
                    } else if (currentLogicalName === "France") {
                        // Highlight only mainland France
                        svg.selectAll("path")
                            .filter(f => countryNameMap[f.id] === "France" && f.properties.name === "France")
                            .classed("country-highlight", true);
                    } else {
                        // For other countries, highlight the specific part hovered.
                        d3.select(this).classed("country-highlight", true);
                    }

                    // Always use the logical name for content
                    if (currentLogicalName !== currentTooltipCountry) {
                        handleMouseOver(event, d, currentLogicalName);
                    }
                    // 只在桌面版顯示爆破效果
                    const isMobileDevice = window.innerWidth <= 768 || 'ontouchstart' in window;
                    if (!isMobileDevice && currentLogicalName !== currentBurstCountry) {
                        showPhotoBurst(event, currentLogicalName);
                    }
                })
                .on("mouseout", function(event, d) {
                    const currentLogicalName = countryNameMap[d.id];
                    if (!currentLogicalName) return;

                    const relatedTarget = event.relatedTarget;
                    let nextLogicalName = null;

                    if (relatedTarget && relatedTarget.tagName === 'path') {
                        const relatedPathData = d3.select(relatedTarget).datum();
                        if (relatedPathData && relatedPathData.id && countryNameMap[relatedPathData.id]) {
                            nextLogicalName = countryNameMap[relatedPathData.id];
                        }
                    }

                    // If mouse is moving to a different logical country, or off the map
                    if (currentLogicalName !== nextLogicalName) {
                        svg.selectAll("path.country-highlight").classed("country-highlight", false);
                        handleMouseOut();    // Clears tooltip and resets currentTooltipCountry
                        // 只在桌面版清理爆破效果
                        const isMobileDevice = window.innerWidth <= 768 || 'ontouchstart' in window;
                        if (!isMobileDevice) {
                            clearPhotoBurst();   // Clears photos and resets currentBurstCountry
                        }
                    }
                    // If moving to another segment of the same logical country (currentLogicalName === nextLogicalName),
                    // the mouseover on the new segment will handle updating highlights.
                    // Tooltip/photoburst will persist due to their internal state (currentTooltipCountry/currentBurstCountry).
                })
                .on("click", function(event, d) {
                    const name = countryNameMap[d.id];
                    if (!name || processedCountries.has(name + '_click')) return;
                    
                    handleCountryClick(event, d, name);
                    // 重置點擊狀態，允許再次點擊
                    setTimeout(() => processedCountries.delete(name + '_click'), 300);
                    processedCountries.add(name + '_click');
                });

            // 新增：在每個有照片的國家預先渲染 2~4 張小縮圖
            // --- 移除小圖渲染功能 ---
            // const renderedCountries = new Set();
            // Object.entries(travelData.countries).forEach(([countryName, countryData]) => {
            //     if (!countryData.posts || countryData.posts.length === 0) return;
            //     // 僅渲染一次美國（排除阿拉斯加、夏威夷等重複）
            //     if (countryName === 'United States') {
            //         if (renderedCountries.has('United States')) return;
            //         // 找出本土（經度 > -130，緯度 < 50）
            //         const usMainland = worldGeoData.features.find(f => {
            //             const n = (f.properties.name || f.properties.NAME);
            //             if (n !== 'United States') return false;
            //             const centroid = d3.geoCentroid(f);
            //             return centroid[0] > -130 && centroid[1] < 50; // 本土大致範圍
            //         });
            //         if (!usMainland) return;
            //         renderCountryPreview(usMainland, countryName, countryData);
            //         renderedCountries.add('United States');
            //         return;
            //     }
            //     // 其他國家正常渲染
            //     if (renderedCountries.has(countryName)) return;
            //     const feature = worldGeoData.features.find(f => (f.properties.name || f.properties.NAME) === countryName);
            //     if (!feature) return;
            //     renderCountryPreview(feature, countryName, countryData);
            //     renderedCountries.add(countryName);
            // });

    // function renderCountryPreview(...) { ... } // 整個函式可保留但不會再被呼叫
        }

        // 放射狀照片顯示
        let currentBurstCountry = null; // 追蹤當前顯示照片爆炸的國家
        let currentlyHoveredCountry = null; // 新增：追蹤當前滑鼠懸停的國家

        function showPhotoBurst(event, countryName) {
            // 不規則照片彈射效果，支援35張照片，更分散的分布
            clearPhotoBurst();
            const countryData = travelData.countries[countryName];
            if (!countryData || !countryData.posts || countryData.posts.length === 0) return;
            
            currentBurstCountry = countryName;
            const burst = document.getElementById('photo-burst');
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            
            // 支援 mediaUrl（後端 key）與 media_url（IG API key）
            const photos = countryData.posts.filter(post => post.mediaUrl || post.media_url || post.thumbnail_url).slice(0, 35);
            if (photos.length === 0) return;
            
            const imgSize = 90; // 照片尺寸
            const usedPositions = []; // 記錄已使用的位置避免重疊
            const minDistance = 95; // 稍微減少最小分離距離，讓更多照片能放置
            
            photos.forEach((post, i) => {
                let x, y, attempts = 0;
                const maxAttempts = 60; // 增加嘗試次數
                
                do {
                    // 完全不規則的分布策略，再增加5%散布範圍
                    if (i < 8) {
                        // 內圈：較小範圍 (再增加5%散布)
                        const angle = Math.random() * 2 * Math.PI;
                        const radius = 88 + Math.random() * 66; // 88-154px (84-147增加5%)
                        x = mouseX + Math.cos(angle) * radius;
                        y = mouseY + Math.sin(angle) * radius;
                    } else if (i < 20) {
                        // 中圈：中等範圍 (再增加5%散布)
                        const angle = Math.random() * 2 * Math.PI;
                        const radius = 154 + Math.random() * 88; // 154-242px (147-231增加5%)
                        x = mouseX + Math.cos(angle) * radius;
                        y = mouseY + Math.sin(angle) * radius;
                    } else {
                        // 外圈：更大範圍 (再增加5%散布)
                        const angle = Math.random() * 2 * Math.PI;
                        const radius = 242 + Math.random() * 111; // 242-353px (231-336增加5%)
                        x = mouseX + Math.cos(angle) * radius;
                        y = mouseY + Math.sin(angle) * radius;
                    }
                    
                    // 添加更大的隨機偏移讓分布更不規則 (再增加5%散布)
                    x += (Math.random() - 0.5) * 66; // 63增加5%
                    y += (Math.random() - 0.5) * 66; // 63增加5%
                    
                    // 添加額外的不規則偏移 (增加更多隨機性)
                    x += (Math.random() - 0.5) * 50; // 從40增加到50
                    y += (Math.random() - 0.5) * 50; // 從40增加到50
                    
                    // 避免照片超出視窗邊界
                    x = Math.max(imgSize/2, Math.min(window.innerWidth - imgSize/2, x));
                    y = Math.max(imgSize/2, Math.min(window.innerHeight - imgSize/2, y));
                    
                    attempts++;
                } while (attempts < maxAttempts && isPositionTooClose(x, y, usedPositions, minDistance));
                
                // 記錄位置
                usedPositions.push({x, y});
                
                const img = document.createElement('img');
                img.className = 'photo-burst-img';
                img.src = post.mediaUrl || post.media_url || post.thumbnail_url;
                img.alt = post.caption || '';
                img.style.left = (x - imgSize/2) + 'px';
                img.style.top = (y - imgSize/2) + 'px';
                img.style.width = img.style.height = imgSize + 'px';
                img.style.zIndex = 3002;
                img.style.cursor = 'pointer';
                img.style.pointerEvents = 'auto';
                
                // 添加圖片載入錯誤處理
                img.onerror = function() {
                    this.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'photo-burst-img error-photo';
                    errorDiv.style.left = this.style.left;
                    errorDiv.style.top = this.style.top;
                    errorDiv.style.width = this.style.width;
                    errorDiv.style.height = this.style.height;
                    errorDiv.style.zIndex = this.style.zIndex;
                    errorDiv.style.background = 'rgba(255, 0, 0, 0.3)';
                    errorDiv.style.border = '2px solid #ff4444';
                    errorDiv.style.borderRadius = '8px';
                    errorDiv.style.display = 'flex';
                    errorDiv.style.alignItems = 'center';
                    errorDiv.style.justifyContent = 'center';
                    errorDiv.style.color = '#fff';
                    errorDiv.style.fontSize = '12px';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.cursor = 'pointer';
                    errorDiv.style.pointerEvents = 'auto';
                    errorDiv.innerHTML = '❌<br>圖片<br>過期';
                    this.parentNode.replaceChild(errorDiv, this);
                };
                
                // 添加點擊事件，打開詳細頁面
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // Add visual feedback
                    img.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        img.style.transform = img.classList.contains('visible') ? 'scale(1)' : 'scale(0.8)';
                    }, 100);
                    
                    // Clear photo burst and show posts
                    clearPhotoBurst();
                    showCountryPosts(countryName, countryData);
                });
                
                // 照片一個一個依序出現，每張間隔50ms（更快的速度）
                const delay = i * 50 + 20; // 第一張20ms後出現，之後每張間隔50ms
                setTimeout(() => img.classList.add('visible'), delay);
                burst.appendChild(img);
            });
        }
        
        // 檢查位置是否與已有位置太接近
        function isPositionTooClose(x, y, usedPositions, minDistance) {
            return usedPositions.some(pos => {
                const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                return distance < minDistance;
            });
        }
        function clearPhotoBurst() {
            const burst = document.getElementById('photo-burst');
            if (burst) burst.innerHTML = '';
            currentBurstCountry = null; // 重置當前國家狀態
        }

        let currentTooltipCountry = null; // 追蹤當前顯示tooltip的國家

        function handleMouseOver(event, d, countryName) {
            // 每次懸停都顯示tooltip，無論是否為同一國家的不同部分
            const tooltip = document.getElementById('tooltip');
            const countryData = travelData.countries[countryName];
            let content = `<strong>${countryName}</strong><br>`;
            if (countryData) {
                content += `${countryData.posts.length} posts, ${countryData.cities.length} cities`;
            } else {
                content += "Not visited yet";
            }
            tooltip.innerHTML = content;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            
            currentTooltipCountry = countryName;
        }

        function handleMouseOut() {
            document.getElementById('tooltip').style.opacity = 0;
            currentTooltipCountry = null; // 重置當前國家狀態
        }

        function handleCountryClick(event, d, countryName) {
            const countryData = travelData.countries[countryName];
            if (countryData) {
                // 檢測是否為手機設備
                const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
                
                if (isMobile) {
                    showCountryPreview(countryName, countryData);
                } else {
                    showCountryPosts(countryName, countryData);
                }
            }
        }

        function showCountryPosts(countryName, countryData) {
            const modal = document.getElementById('posts-modal');
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const grid = document.getElementById('posts-grid');

            title.textContent = `📍 ${countryData.name || countryName}`;
            subtitle.textContent = `${countryData.posts.length} posts from Vera's adventures`;

            grid.innerHTML = '';
            
            countryData.posts.forEach(post => {
                const postCard = createPostCard(post);
                grid.appendChild(postCard);
            });

            modal.style.display = 'block';
            // Add smooth animation
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function createPostCard(post) {
            const card = document.createElement('div');
            card.className = 'post-card';
            // 若有圖片，顯示縮圖
            let imgHtml = '';
            const imgSrc = post.mediaUrl || post.media_url || post.thumbnail_url;
            if (imgSrc) {
                imgHtml = `<img src="${imgSrc}" alt="" style="width:100%;height:180px;object-fit:cover;" 
                    onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'post-image error\\'>❌ 圖片載入失敗<br><small>URL已過期</small></div>';">`;
            } else {
                imgHtml = `<div class="post-image">${post.media_type === 'VIDEO' ? '🎥' : '📷'}</div>`;
            }
            // 地點顯示優化
            let location = '';
            const city = post.location && post.location.city ? post.location.city.trim() : '';
            const country = post.location && post.location.country ? post.location.country.trim() : '';
            if (city && country) {
                location = `${city}, ${country}`;
            } else if (country) {
                location = country;
            } else if (post.location && post.location.coordinates && window.worldGeoData) {
                // GPS 反查國家
                const cleanedCountries = travelData && travelData.countries ? Object.keys(travelData.countries) : [];
                const normCountry = normalizeCountryName('', post, cleanedCountries);
                if (normCountry) location = normCountry;
            }
            if (!location && post.caption) {
                // 從 caption 推斷
                const cleanedCountries = travelData && travelData.countries ? Object.keys(travelData.countries) : [];
                const normCountry = normalizeCountryName('', post, cleanedCountries);
                if (normCountry) location = normCountry;
            }
            if (!location) {
                location = 'Unknown location';
            }
            // 避免多餘逗號、空白
            location = location.replace(/^,\s*/, '').replace(/,\s*$/, '').replace(/\s+,/g, ',');
            const date = new Date(post.timestamp).toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const caption = post.caption ? 
                (post.caption.length > 80 ? post.caption.substring(0, 80) + '...' : post.caption) : 
                'No caption available';
            card.innerHTML = `
                ${imgHtml}
                <div class="post-content">
                    <div class="post-location">${location}</div>
                    <div class="post-date">${date}</div>
                    <div class="post-caption">${caption}</div>
                </div>
            `;
            card.addEventListener('click', () => {
                if (post.permalink) {
                    window.open(post.permalink, '_blank');
                }
            });
            return card;
        }

        function closePosts() {
            const modal = document.getElementById('posts-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // 國家預覽抽屜函數
        let currentPreviewCountry = null;

        function showCountryPreview(countryName, countryData) {
            currentPreviewCountry = {name: countryName, data: countryData};
            
            const preview = document.getElementById('country-preview');
            const title = document.getElementById('preview-title');
            const posts = document.getElementById('preview-posts');
            const cities = document.getElementById('preview-cities');
            const latest = document.getElementById('preview-latest');
            const photos = document.getElementById('preview-photos');

            // 更新內容
            title.textContent = countryData.name || countryName;
            posts.textContent = countryData.posts.length;
            cities.textContent = countryData.cities ? countryData.cities.length : 
                                [...new Set(countryData.posts.map(p => p.location?.city).filter(Boolean))].length;

            // 找到最新貼文日期
            if (countryData.posts.length > 0) {
                const latestPost = countryData.posts.reduce((latest, post) => {
                    return new Date(post.timestamp) > new Date(latest.timestamp) ? post : latest;
                });
                const date = new Date(latestPost.timestamp);
                latest.textContent = date.getFullYear() + '/' + (date.getMonth() + 1);
            } else {
                latest.textContent = '-';
            }

            // 顯示前3張照片
            photos.innerHTML = '';
            const photoPosts = countryData.posts.slice(0, 3);
            photoPosts.forEach(post => {
                const imgSrc = post.mediaUrl || post.media_url || post.thumbnail_url;
                if (imgSrc) {
                    const img = document.createElement('img');
                    img.className = 'country-preview-photo';
                    img.src = imgSrc;
                    img.alt = post.caption || '';
                    img.onerror = function() {
                        this.style.display = 'none';
                    };
                    photos.appendChild(img);
                }
            });

            // 顯示抽屜
            preview.classList.add('show');
        }

        function closeCountryPreview() {
            const preview = document.getElementById('country-preview');
            preview.classList.remove('show');
            currentPreviewCountry = null;
        }

        function viewCountryDetails() {
            if (currentPreviewCountry) {
                closeCountryPreview();
                showCountryPosts(currentPreviewCountry.name, currentPreviewCountry.data);
            }
        }

        function updateStats() {
            const countries = Object.keys(travelData.countries).length;
            const cities = Object.values(travelData.countries)
                .reduce((acc, country) => acc + country.cities.length, 0);
            const posts = Object.values(travelData.countries)
                .reduce((acc, country) => acc + country.posts.length, 0);

            animateNumber('countries-count', countries);
            animateNumber('cities-count', cities);
            animateNumber('posts-count', posts);
        }

        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            let currentValue = 0;
            const increment = Math.ceil(targetValue / 20);
            
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = currentValue;
            }, 50);
        }

        function showError() {
            document.getElementById('loading').innerHTML = `
                <div style="color: #ffffff;">❌ 載入失敗</div>
                <div style="margin-top: 10px;">
                    <button onclick="location.reload()" style="
                        background: #333333; 
                        color: white; 
                        border: 1px solid #666666; 
                        padding: 10px 20px; 
                        border-radius: 4px; 
                        cursor: pointer;
                    ">重新載入</button>
                </div>
            `;
        }

        // 響應式調整
        window.addEventListener('resize', () => {
            if (svg) {
                renderMap();
            }
        });

        // ESC 關閉 modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePosts();
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
